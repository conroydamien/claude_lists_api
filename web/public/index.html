<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude Lists</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    h1 {
      margin-bottom: 20px;
    }
    select {
      font-size: 1rem;
      padding: 6px 10px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 8px 12px;
      border-bottom: 1px solid #ddd;
    }
    th {
      background: #f5f5f5;
    }
    .done td:not(:first-child) {
      text-decoration: line-through;
      color: #999;
    }
    tr:not(.done) {
      cursor: pointer;
    }
    tr:not(.done):hover {
      background: #f9f9f9;
    }
    .undo-btn {
      background: none;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 1.1rem;
      line-height: 1;
      color: #666;
    }
    .undo-btn:hover {
      background: #eee;
    }
    #message {
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Claude Lists</h1>

  <label for="list-select">Choose a list:</label>
  <select id="list-select">
    <option value="">-- Select a list --</option>
  </select>

  <table id="items-table" hidden>
    <thead>
      <tr>
        <th>Done</th>
        <th>Title</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody id="items-body"></tbody>
  </table>

  <p id="message"></p>

  <script>
    const API = `http://${window.location.hostname}:3000`;
    const listSelect = document.getElementById("list-select");
    const itemsTable = document.getElementById("items-table");
    const itemsBody = document.getElementById("items-body");
    const message = document.getElementById("message");

    // Fetch all lists and populate the dropdown.
    async function loadLists() {
      const resp = await fetch(`${API}/lists?order=name`);
      const lists = await resp.json();
      lists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        listSelect.appendChild(opt);
      });
    }

    // Fetch items for the selected list and render the table.
    let loadRequestId = 0;
    async function loadItems(listId) {
      const thisRequest = ++loadRequestId;
      itemsBody.innerHTML = "";

      if (!listId) {
        itemsTable.hidden = true;
        message.textContent = "";
        return;
      }

      const resp = await fetch(`${API}/items?list_id=eq.${listId}&order=id`);
      if (thisRequest !== loadRequestId) return;
      const items = await resp.json();
      if (thisRequest !== loadRequestId) return;

      itemsBody.innerHTML = "";

      if (items.length === 0) {
        itemsTable.hidden = true;
        message.textContent = "No items in this list.";
        return;
      }

      message.textContent = "";
      itemsTable.hidden = false;

      items.forEach((item) => {
        const tr = document.createElement("tr");
        if (item.done) tr.classList.add("done");

        if (item.done) {
          const undoBtn = document.createElement("button");
          undoBtn.className = "undo-btn";
          undoBtn.textContent = "\u21A9";
          undoBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            setDone(item.id, false);
          });
          const td = document.createElement("td");
          td.appendChild(undoBtn);
          tr.appendChild(td);
        } else {
          tr.innerHTML = `<td></td>`;
          tr.addEventListener("click", () => setDone(item.id, true));
        }

        tr.insertAdjacentHTML("beforeend", `
          <td>${escapeHtml(item.title)}</td>
          <td>${escapeHtml(item.description || "")}</td>
        `);

        itemsBody.appendChild(tr);
      });
    }

    // Set the done status of an item via PATCH. UI updates via WebSocket.
    async function setDone(itemId, done) {
      await fetch(`${API}/items?id=eq.${itemId}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ done }),
      });
    }

    // Prevent XSS when rendering user content.
    function escapeHtml(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    // Debounce loadItems so rapid WebSocket messages don't cause duplicates.
    let reloadTimer = null;
    function scheduleReload() {
      clearTimeout(reloadTimer);
      reloadTimer = setTimeout(() => loadItems(listSelect.value), 100);
    }

    // WebSocket connection for real-time updates with auto-reconnect.
    function connectWS() {
      const ws = new WebSocket(`ws://${window.location.hostname}:9000`);
      ws.addEventListener("message", (event) => {
        const data = JSON.parse(event.data);
        if (listSelect.value && String(data.list_id) === listSelect.value) {
          scheduleReload();
        }
      });
      ws.addEventListener("close", () => setTimeout(connectWS, 2000));
      ws.addEventListener("error", () => ws.close());
    }
    connectWS();

    listSelect.addEventListener("change", () => loadItems(listSelect.value));
    loadLists();
  </script>
</body>
</html>
