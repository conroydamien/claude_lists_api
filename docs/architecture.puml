@startuml Claude Lists API Architecture

skinparam componentStyle rectangle

actor "Client" as client

node "Podman Compose" {
    component "Web App\n(HTTP 8080 / HTTPS 8443)" as web
    component "PostgREST\n(port 3000)" as postgrest
    component "WS Sidecar\n(port 9000)" as wssidecar
    component "Keycloak\n(port 8180)" as keycloak
    component "Seeder\n(one-shot)" as seeder
    database "PostgreSQL 16\n(port 5433)" as db

    web --> postgrest : "/api/* proxy"
    web --> keycloak : "OAuth2/OIDC\nlogin flow"
    seeder --> postgrest : "POST seed data\non startup"
    postgrest --> db : "connects as\nclaude_lists user"
    db --> wssidecar : "LISTEN/NOTIFY\nitems_changed,\ncomments_changed"
}

client --> web : "HTTPS :8443\n(or HTTP :8080)"
client --> wssidecar : "WebSocket\nport 9000"
client --> keycloak : "login redirect\nport 8180"

note left of client
  LAN access requires
  socat port forwarding
  (see lan-proxy.sh)
end note

note right of db
  Database: claude_lists
  Roles:
    - claude_lists (owner)
    - web_anon (anonymous CRUD)
    - web_user (authenticated CRUD)
end note

note bottom of db
  Tables:
    - lists (id, name, description,
             created_at, updated_at)
    - items (id, list_id FK->lists,
             title, description, done,
             created_at, updated_at)
    - comments (id, item_id FK->items,
             author_id, author_name,
             content, created_at)
             RLS: delete own only
  Triggers:
    - items_changed (AFTER INSERT/
      UPDATE/DELETE on items)
    - comments_changed (AFTER INSERT/
      UPDATE/DELETE on comments)
end note

note right of postgrest
  JWT validated via JWKS
  Role from token claim
end note

note right of keycloak
  Realm: claude-lists
  Users: alice, bob, charlie
  Provides JWT with sub,
  preferred_username, role
end note

note right of wssidecar
  Broadcasts item changes
  to connected WebSocket clients
end note

note right of seeder
  Loads seed data via REST API
  on first startup, then exits
end note

note left of web
  HTTPS with self-signed cert
  API proxy avoids mixed content
  Static files + Express server
end note

@enduml
