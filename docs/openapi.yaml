openapi: 3.0.3
info:
  title: Court Lists API
  description: Backend API for the Court Lists mobile app - fetches and manages Irish court listings
  version: 1.1.0
servers:
  - url: https://fbiissfiqgtlenxkjuwv.supabase.co/functions/v1
    description: Supabase Edge Functions

security:
  - BearerAuth: []

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: |
        Google ID Token (not Supabase JWT).
        Obtained via Google Sign-In on iOS/Android.
        Backend validates against oauth2.googleapis.com/tokeninfo.
        User ID is derived from Google ID via SHA-256 hash formatted as UUID.

  schemas:
    DiaryEntry:
      type: object
      properties:
        dateText:
          type: string
          example: "Monday 3rd February 2026"
        dateIso:
          type: string
          format: date
          example: "2026-02-03"
        venue:
          type: string
          example: "Dublin"
        type:
          type: string
          example: "Criminal"
        subtitle:
          type: string
          example: "Judge Smith"
        updated:
          type: string
          example: "02/02/2026"
        sourceUrl:
          type: string
          format: uri
          example: "https://legaldiary.courts.ie/legaldiary.nsf/circuit-court/ABC123"

    ParsedCase:
      type: object
      properties:
        listNumber:
          type: integer
          nullable: true
          example: 1
        listSuffix:
          type: string
          nullable: true
          description: Single character suffix for items like "4a", "10b"
          example: "a"
        caseNumber:
          type: string
          nullable: true
          example: "2024/1234"
        title:
          type: string
          example: "Smith v Jones"
        parties:
          type: string
          nullable: true
          example: "Smith v Jones"
        isCase:
          type: boolean
          example: true

    CasesResponse:
      type: object
      properties:
        cases:
          type: array
          items:
            $ref: '#/components/schemas/ParsedCase'
        headers:
          type: array
          items:
            type: string
          example: ["FOR MENTION", "AT 10:30"]

    Comment:
      type: object
      properties:
        id:
          type: integer
        list_source_url:
          type: string
        case_number:
          type: string
        list_number:
          type: integer
          description: Position of the case in the court list
          example: 4
        user_id:
          type: string
          format: uuid
        author_name:
          type: string
        content:
          type: string
        urgent:
          type: boolean
        created_at:
          type: string
          format: date-time

    CaseStatus:
      type: object
      properties:
        list_source_url:
          type: string
        case_number:
          type: string
        list_number:
          type: integer
          description: Position of the case in the court list (part of primary key)
          example: 4
        done:
          type: boolean
        updated_by:
          type: string
          format: uuid
        updated_at:
          type: string
          format: date-time

    WatchedCase:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: string
          format: uuid
        list_source_url:
          type: string
        case_number:
          type: string
        list_number:
          type: integer
          description: Position of the case in the court list
          example: 4
        source:
          type: string
          enum: [manual, auto]
        created_at:
          type: string
          format: date-time

    Notification:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: string
          format: uuid
        type:
          type: string
          enum: [comment, status_done, status_undone]
        list_source_url:
          type: string
        case_number:
          type: string
        list_number:
          type: integer
          nullable: true
          description: Position of the case in the court list
          example: 4
        case_title:
          type: string
          nullable: true
        actor_name:
          type: string
        actor_id:
          type: string
          format: uuid
          nullable: true
        content:
          type: string
          nullable: true
          description: Comment content (for comment notifications)
        read:
          type: boolean
        created_at:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        error:
          type: string

    MessageResponse:
      type: object
      properties:
        message:
          type: string

  responses:
    Forbidden:
      description: Account is blocked
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Account is blocked"

paths:
  /listings:
    get:
      summary: Get court listings
      description: Fetches court listings from courts.ie for a specific date and court type
      tags: [Listings]
      parameters:
        - name: date
          in: query
          required: true
          schema:
            type: string
            format: date
          example: "2026-02-03"
        - name: court
          in: query
          required: false
          schema:
            type: string
            enum: [circuit-court, high-court, court-of-appeal]
            default: circuit-court
      responses:
        '200':
          description: List of court diary entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DiaryEntry'
        '400':
          description: Invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      summary: Get court listings (POST)
      description: Same as GET but accepts JSON body
      tags: [Listings]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [date]
              properties:
                date:
                  type: string
                  format: date
                  example: "2026-02-03"
                court:
                  type: string
                  enum: [circuit-court, high-court, court-of-appeal]
                  default: circuit-court
      responses:
        '200':
          description: List of court diary entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DiaryEntry'
        '403':
          $ref: '#/components/responses/Forbidden'

  /cases:
    get:
      summary: Get cases from a list
      description: Fetches and parses case details from a specific court list URL
      tags: [Cases]
      parameters:
        - name: url
          in: query
          required: true
          schema:
            type: string
            format: uri
          example: "https://legaldiary.courts.ie/legaldiary.nsf/circuit-court/ABC123"
      responses:
        '200':
          description: Parsed cases and headers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CasesResponse'
        '400':
          description: Invalid URL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      summary: Get cases from a list (POST)
      description: Same as GET but accepts JSON body
      tags: [Cases]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url]
              properties:
                url:
                  type: string
                  format: uri
      responses:
        '200':
          description: Parsed cases and headers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CasesResponse'
        '403':
          $ref: '#/components/responses/Forbidden'

  /case-status:
    get:
      summary: Get case statuses
      description: Get done/undone status for cases in a list
      tags: [Case Status]
      parameters:
        - name: list_source_url
          in: query
          required: true
          schema:
            type: string
        - name: case_numbers
          in: query
          required: true
          description: Comma-separated list of case numbers
          schema:
            type: string
          example: "2024/1234,2024/5678"
      responses:
        '200':
          description: Array of case statuses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CaseStatus'
        '400':
          description: Missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      summary: Upsert case status
      description: Set done/undone status for a case. Notifies watchers of the change.
      tags: [Case Status]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [list_source_url, case_number, done]
              properties:
                list_source_url:
                  type: string
                case_number:
                  type: string
                list_number:
                  type: integer
                  description: Position in the court list (defaults to 0)
                  default: 0
                done:
                  type: boolean
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "Status updated"
        '400':
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

  /comments:
    get:
      summary: Get comments
      description: Get comments for a specific case, or comment counts for multiple cases
      tags: [Comments]
      parameters:
        - name: list_source_url
          in: query
          required: true
          schema:
            type: string
        - name: case_number
          in: query
          required: false
          schema:
            type: string
          description: Get full comments for a single case
        - name: case_numbers
          in: query
          required: false
          schema:
            type: string
          description: Comma-separated case numbers to get comment counts
        - name: list_number
          in: query
          required: false
          schema:
            type: integer
          description: Filter by list position
      responses:
        '200':
          description: List of comments (case_number) or comment data for counts (case_numbers)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Comment'
        '400':
          description: Missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      summary: Create comment
      description: Add a new comment to a case or list. Notifies watchers.
      tags: [Comments]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [list_source_url, case_number, content]
              properties:
                list_source_url:
                  type: string
                case_number:
                  type: string
                list_number:
                  type: integer
                  description: Position in the court list (defaults to 0)
                  default: 0
                content:
                  type: string
                  maxLength: 1000
                urgent:
                  type: boolean
                  default: false
                  description: "Marks comment with red hand icon for 'needs help'"
      responses:
        '201':
          description: Comment added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "Comment added"
        '400':
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

    delete:
      summary: Delete comment
      description: Delete a comment (only owner can delete). Accepts JSON body.
      tags: [Comments]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id]
              properties:
                id:
                  type: integer
      responses:
        '200':
          description: Comment deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "Comment deleted"
        '403':
          $ref: '#/components/responses/Forbidden'

  /watched-cases:
    get:
      summary: Get watched cases
      description: Get all cases/lists the user is watching
      tags: [Watched Cases]
      responses:
        '200':
          description: List of watched cases
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WatchedCase'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      summary: Watch a case
      description: Start watching a case or list for updates. Accepts JSON body.
      tags: [Watched Cases]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [list_source_url, case_number]
              properties:
                list_source_url:
                  type: string
                case_number:
                  type: string
                list_number:
                  type: integer
                  description: Position in the court list (defaults to 0)
                  default: 0
                source:
                  type: string
                  enum: [manual, auto]
                  default: manual
      responses:
        '200':
          description: Already watching
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "Already watching"
        '201':
          description: Watch created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "Watching case"
        '403':
          $ref: '#/components/responses/Forbidden'

    delete:
      summary: Unwatch a case
      description: Stop watching a case or list. Accepts JSON body.
      tags: [Watched Cases]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [list_source_url, case_number]
              properties:
                list_source_url:
                  type: string
                case_number:
                  type: string
                list_number:
                  type: integer
                  description: Position in the court list (defaults to 0)
                  default: 0
      responses:
        '200':
          description: Watch removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
              example:
                message: "Unwatched case"
        '403':
          $ref: '#/components/responses/Forbidden'

  /notifications:
    get:
      summary: Get notifications
      description: Get all notifications for the current user
      tags: [Notifications]
      parameters:
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
          description: Maximum number of notifications to return
      responses:
        '200':
          description: List of notifications (newest first)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Notification'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

    patch:
      summary: Mark notification(s) as read
      description: Mark a single notification or all notifications as read. Accepts JSON body.
      tags: [Notifications]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: integer
                  description: Mark a single notification as read
                all:
                  type: boolean
                  description: If true, marks all notifications as read
      responses:
        '200':
          description: Update confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Missing id or all
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'

    delete:
      summary: Delete notification(s)
      description: Delete a single notification or all notifications. Accepts JSON body.
      tags: [Notifications]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: integer
                  description: Delete a single notification
                all:
                  type: boolean
                  description: If true, deletes all notifications
      responses:
        '200':
          description: Deletion confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Missing id or all
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          $ref: '#/components/responses/Forbidden'
